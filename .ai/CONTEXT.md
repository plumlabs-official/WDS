# Current Context

> 현재 작업 상태 및 세션 정보
>
> 마지막 업데이트: 2026-01-16 (밤)

---

## Figma 파일

| 항목 | 값 |
|------|-----|
| URL | https://www.figma.com/design/s4GdImD87fQsWwnRYQVbWV/App?node-id=14451-4060 |
| fileKey | `s4GdImD87fQsWwnRYQVbWV` |
| nodeId | `14451:4060` (Two-Stage 테스트 완료 화면) |
| 페이지 | [All] (전체 플로우 모음) |

---

## 현재 작업

### 완료됨 (2026-01-16 밤) - 래퍼 제거 안정화

#### 해결된 이슈

1. **GROUP 부모 좌표 틀어짐**
   - 증상: 이미지 y좌표 357 → 308 이동
   - 원인: GROUP은 자식 변경 시 bounding box 재계산
   - 해결: `isMeaninglessWrapper`, `isAggressiveWrapper`에서 GROUP 부모 체크

2. **Auto Layout 빈 요소 제거 시 reposition**
   - 증상: 텍스트 x좌표 0 → 20.5 이동
   - 원인: Auto Layout 내부 빈 프레임 제거 시 형제 재배치
   - 해결: `isEmptyFrame`에서 Auto Layout 부모 체크

3. **의도적 프레임("Hidden" 등) 제거**
   - 증상: Rectangle 2665 위치 이동, Frame 1 밀림
   - 원인: 자동생성 이름만 체크, 의도적 이름 구분 없음
   - 해결: `isAutoGeneratedName` 체크 추가

4. **같은 이름 다른 크기 병합 오류**
   - 증상: textfield+dsc (h=84) ↔ textfield+dsc (h=144) 잘못 병합
   - 원인: 같은 이름이면 크기 체크 스킵
   - 해결: `flattenSameNameChain`에서 크기 체크 (tolerance 20px)

#### 비활성화된 기능

- **Deep Flatten** (Auto Layout 단일자식 병합)
  - 이유: 기존 `flattenSameNameChain`과 충돌, padding/속성 인계 불완전
  - 상태: 코드 남아있으나 주석 처리됨
  - 다음: 구조적 재설계 필요

- **AL 언래핑** (Auto Layout 내부 무의미 프레임 언래핑) - 2026-01-16 오후
  - 시도: padding < 4px이고 시각적 스타일 없는 중간 프레임 제거
  - 이유: Alignment 속성 손실, 레이아웃 깨짐
  - 상태: `unwrapInsignificantALChildren` 함수 존재하나 호출 주석 처리
  - 교훈: 수동 테스트에서는 작동했으나 자동화 시 edge case 발생

#### 수정된 파일

- `src/modules/cleanup.ts`
  - `isMeaninglessWrapper`: GROUP 부모 체크, 자동생성 이름 체크
  - `isAggressiveWrapper`: GROUP 부모 체크, 자동생성 이름 체크
  - `isEmptyFrame`: Auto Layout 부모 체크
  - `flattenSameNameChain`: 크기 체크 강화 (같은 이름도 20px tolerance)
  - `deepFlattenNode`: 비활성화

---

## 남은 이슈 (다음 세션)

### 중첩 레이어 구조 문제

현재 구조 (예: textfield+dsc):
```
textfield+dsc (1)
  └─ textfield+dsc (2) - 같은 이름 중첩
      └─ textfield (3)
          └─ txt+count (4)
              ├─ text
              └─ Frame 1430106950 (5) - 텍스트 감싸는 프레임
                  └─ text
```

목표 구조:
```
textfield+dsc
  ├─ text
  └─ text
```

**접근 방향:**
1. 측정: 현재 평균/최대 중첩 깊이 통계
2. 규칙: "의미있는 중첩" vs "제거 대상" 기준 명확화
3. Deep Flatten 재설계

---

## Agent Server

```bash
# 통합 빌드 (권장)
npm run build:all

# 서버 실행
npm run server
# http://localhost:3001
```

---

## 다음 세션 참고

1. **래퍼 제거**: 현재 버전 안정화 완료, 중첩 레이어는 별도 작업
2. **모델 선택**: Two-Stage가 기본값 (추천)
3. **빌드**: `npm run build:all` 사용 (플러그인+서버)
4. **비용 확인**: `/price` 커맨드

### 모델별 가격 (per 1M tokens)

| 모델 | Input | Output | 특징 |
|------|-------|--------|------|
| Haiku | $1 | $5 | 빠름, 저렴 |
| Sonnet | $3 | $15 | 균형 |
| Opus | $15 | $75 | 최고 품질 |
| Two-Stage | ~$1.3 | ~$6.5 | 비용 효율 + 품질 |
